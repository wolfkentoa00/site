<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYPER-TUNER | Pure Engine Simulator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;900&display=swap');
        
        body { margin: 0; background: #050505; color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
        
        /* Loading Animation */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Grid Background */
        .tech-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom": "https://esm.sh/react-dom@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://esm.sh/three@0.161.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.102.0?external=react,react-dom,three,@react-three/fiber",
                "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom"
            }
        }
    </script>
</head>
<body>
    <div id="root" class="h-screen w-screen flex items-center justify-center">
        <div class="text-center">
            <div class="loader mb-4"></div>
            <div class="text-xs font-mono text-red-500 tracking-widest">ASSEMBLING ENGINE BLOCK...</div>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame } from '@react-three/fiber';
        import { OrbitControls, Stage, PerspectiveCamera, Environment, Grid, Stars, ContactShadows, Text, Cylinder } from '@react-three/drei';
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, AreaChart, Area } from 'recharts';
        import { Gauge, Zap, Activity, Settings, Play, RotateCcw, Trophy, Wind, CircleDashed, Cpu, Layers } from 'lucide-react';

        // --- DATABASE WITH ENGINE TYPES ---
        const CAR_DB = [
            { id: 'p1', name: 'Porsche 911 GT3 RS', hp: 518, tq: 342, type: 'flat6', desc: '4.0L NA Flat-6' },
            { id: 'b1', name: 'BMW M340i (B58)', hp: 382, tq: 369, type: 'inline6', desc: '3.0L Turbo I6' },
            { id: 'j2', name: 'Toyota Supra MK4 (2JZ)', hp: 320, tq: 315, type: 'inline6', desc: '3.0L Twin-Turbo I6' },
            { id: 'a1', name: 'Audi RS7 (V8)', hp: 591, tq: 590, type: 'v8', desc: '4.0L Twin-Turbo V8' },
            { id: 'f1', name: 'Ferrari 458', hp: 562, tq: 398, type: 'v8', desc: '4.5L NA V8' },
            { id: 'a2', name: 'Audi R8 V10', hp: 602, tq: 413, type: 'v10', desc: '5.2L NA V10' },
            { id: 'l1', name: 'Lambo Aventador', hp: 759, tq: 531, type: 'v12', desc: '6.5L NA V12' },
        ];

        // --- ENGINE CONFIGURATIONS ---
        // Defines the geometry of cylinder placement
        const ENGINE_CONFIGS = {
            inline6: { cylinders: 6, layout: 'inline', angle: 0, offset: 0.6, firingOrder: [0, 4, 2, 5, 1, 3] }, // 1-5-3-6-2-4
            v8: { cylinders: 8, layout: 'v', angle: Math.PI / 2, offset: 0.55, firingOrder: [0, 1, 3, 2, 6, 7, 5, 4] }, // Crossplane-ish
            v10: { cylinders: 10, layout: 'v', angle: Math.PI / 2, offset: 0.5, firingOrder: [0, 1, 4, 5, 2, 3, 8, 9, 6, 7] }, // V10 Firing
            v12: { cylinders: 12, layout: 'v', angle: Math.PI / 3, offset: 0.45, firingOrder: [0, 6, 4, 10, 2, 8, 5, 11, 1, 7, 3, 9] }, // V12 Smoothness
            flat6: { cylinders: 6, layout: 'flat', angle: Math.PI, offset: 0.6, firingOrder: [0, 3, 1, 4, 2, 5] }, // Boxer
        };

        // --- 3D COMPONENTS ---

        // Single Piston Component
        const Piston = ({ position, rotation, delayOffset, rpm, isFiring }) => {
            const groupRef = useRef();
            const pistonRef = useRef();
            const rodRef = useRef();
            const materialRef = useRef();

            useFrame((state) => {
                // Calculate Piston Cycle (0 to 1) based on Time and RPM
                // RPM / 60 = Revs per second. * 2PI = Rads per second.
                const speed = (rpm / 60) * Math.PI * 2;
                const time = state.clock.elapsedTime * (rpm > 0 ? 1 : 0); // Freeze time if 0 rpm
                
                // Piston motion: Sin wave
                const cycle = Math.sin((time * speed) + delayOffset);
                const cycleNormalized = (cycle + 1) / 2; // 0 to 1

                // Move Piston Head
                pistonRef.current.position.y = cycle * 0.3; 

                // Rotate/Move Connecting Rod (Simplified visual logic)
                rodRef.current.rotation.z = Math.cos((time * speed) + delayOffset) * 0.15;
                rodRef.current.position.y = (cycle * 0.3) - 0.5;

                // Visual Firing: Flash color when near Top Dead Center (TDC) of Compression stroke
                // Simplified: Flash every other peak for 4-stroke cycle
                // We fake it visually by just checking the sin wave peak
                if (rpm > 100 && cycle > 0.95) {
                    materialRef.current.color.set('#ff5500'); // Ignition Flash
                    materialRef.current.emissive.set('#ff2200');
                    materialRef.current.emissiveIntensity = 2;
                } else {
                    // Cool down
                    materialRef.current.color.lerp(new THREE.Color('#888'), 0.1);
                    materialRef.current.emissive.lerp(new THREE.Color('#000'), 0.1);
                    materialRef.current.emissiveIntensity = 0;
                }
            });

            return (
                <group ref={groupRef} position={position} rotation={rotation}>
                    {/* Cylinder Wall (Transparent Ghost) */}
                    <mesh position={[0, 0, 0]}>
                        <cylinderGeometry args={[0.35, 0.35, 0.8, 16, 1, true]} />
                        <meshStandardMaterial color="#444" wireframe opacity={0.1} transparent />
                    </mesh>

                    {/* Piston Head */}
                    <mesh ref={pistonRef}>
                        <cylinderGeometry args={[0.32, 0.32, 0.25, 32]} />
                        <meshStandardMaterial ref={materialRef} color="#888" metalness={0.8} roughness={0.2} />
                    </mesh>

                    {/* Connecting Rod */}
                    <mesh ref={rodRef} position={[0, -0.5, 0]}>
                        <boxGeometry args={[0.08, 0.8, 0.08]} />
                        <meshStandardMaterial color="#555" metalness={0.9} roughness={0.1} />
                    </mesh>
                </group>
            );
        };

        const EngineAssembly = ({ configName, rpm, isRunning }) => {
            const config = ENGINE_CONFIGS[configName];
            const engineRef = useRef();

            useFrame((state) => {
                // Engine Vibration Shake
                if (isRunning && engineRef.current) {
                    const shake = (rpm / 8000) * 0.005;
                    engineRef.current.position.x = (Math.random() - 0.5) * shake;
                    engineRef.current.position.z = (Math.random() - 0.5) * shake;
                }
            });

            // Generate Pistons based on layout
            const pistons = useMemo(() => {
                const parts = [];
                const cylCount = config.cylinders;
                const offset = config.offset;
                
                for (let i = 0; i < cylCount; i++) {
                    let pos = [0, 0, 0];
                    let rot = [0, 0, 0];
                    let delay = 0;

                    // Calculate Delay based on firing order for visual smoothness
                    // We map the firing order index to a phase shift
                    const firingIndex = config.firingOrder.indexOf(i);
                    const phase = (firingIndex / cylCount) * Math.PI * 4; // *4 for 4-stroke cycle spread

                    if (config.layout === 'inline') {
                        pos = [0, 0, (i - cylCount / 2) * offset];
                        rot = [0, 0, 0];
                    } else if (config.layout === 'v' || config.layout === 'flat') {
                        // Determine Bank (Left/Right)
                        const isLeft = i % 2 === 0;
                        const zPos = (Math.floor(i / 2) - cylCount / 4) * offset;
                        
                        const bankAngle = config.layout === 'flat' ? Math.PI / 2 : config.angle / 2;
                        
                        pos = [
                            isLeft ? Math.sin(bankAngle) * 0.5 : -Math.sin(bankAngle) * 0.5,
                            isLeft ? Math.cos(bankAngle) * 0.5 : Math.cos(bankAngle) * 0.5,
                            zPos
                        ];
                        
                        // Rotate cylinder to face center
                        rot = [0, 0, isLeft ? -bankAngle : bankAngle];
                    }
                    
                    parts.push({ id: i, pos, rot, delay: phase });
                }
                return parts;
            }, [configName]);

            return (
                <group ref={engineRef}>
                    {/* Render Pistons */}
                    {pistons.map((p) => (
                        <Piston 
                            key={p.id} 
                            position={p.pos} 
                            rotation={p.rot} 
                            delayOffset={p.delay}
                            rpm={rpm}
                        />
                    ))}

                    {/* Central Crankshaft Representation */}
                    <mesh rotation={[Math.PI / 2, 0, 0]}>
                        <cylinderGeometry args={[0.05, 0.05, config.cylinders * config.offset + 0.5, 8]} />
                        <meshStandardMaterial color="#333" metalness={1} roughness={0.2} />
                    </mesh>
                    
                    {/* Visual Engine Mount / Floor Shadow */}
                    <mesh position={[0, -2, 0]} rotation={[-Math.PI/2, 0, 0]}>
                        <planeGeometry args={[10, 10]} />
                        <meshStandardMaterial color="#000" opacity={0.5} transparent />
                    </mesh>
                </group>
            );
        };

        const Scene = ({ engineType, rpm, isRunning }) => {
            return (
                <>
                    <PerspectiveCamera makeDefault position={[3, 2, 4]} fov={50} />
                    <OrbitControls autoRotate={isRunning} autoRotateSpeed={1} />
                    
                    <ambientLight intensity={0.5} />
                    <pointLight position={[5, 5, 5]} intensity={1} color="#fff" />
                    <pointLight position={[-5, 5, -5]} intensity={1} color="#fff" />
                    <spotLight position={[0, 10, 0]} angle={0.5} intensity={2} castShadow />

                    {/* Environment */}
                    <Environment preset="city" />
                    <Stars radius={100} depth={50} count={2000} factor={4} saturation={0} fade speed={0.5} />
                    
                    {/* The Engine */}
                    <EngineAssembly configName={engineType} rpm={rpm} isRunning={isRunning} />
                </>
            );
        };

        // --- MAIN UI & LOGIC ---
        const App = () => {
            const [selectedCar, setSelectedCar] = useState(CAR_DB[0]);
            const [mods, setMods] = useState({ tune: false, turbo: false, exhaust: false });
            
            // Simulation State
            const [dynoRunning, setDynoRunning] = useState(false);
            const [rpm, setRpm] = useState(0); // 0 is engine off
            const [data, setData] = useState([]);
            
            // Audio Context
            const audioCtx = useRef(null);
            const osc = useRef(null);
            
            // Toggle Ignition (Idle)
            const [ignition, setIgnition] = useState(false);

            useEffect(() => {
                // Handle Idle RPM
                if (ignition && !dynoRunning) {
                    setRpm(850); // Idle speed
                } else if (!ignition) {
                    setRpm(0);
                }
            }, [ignition, dynoRunning]);

            // Audio Engine
            useEffect(() => {
                if (ignition && !audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    const o = audioCtx.current.createOscillator();
                    const g = audioCtx.current.createGain();
                    o.type = 'sawtooth'; // Raspy engine sound
                    o.connect(g);
                    g.connect(audioCtx.current.destination);
                    o.start();
                    osc.current = { o, g };
                } else if (!ignition && audioCtx.current) {
                    osc.current.o.stop();
                    audioCtx.current.close();
                    audioCtx.current = null;
                }

                if (osc.current) {
                    // Update pitch with RPM
                    const baseFreq = selectedCar.type.includes('v') ? 50 : 70; // V engines lower rumble
                    const freq = baseFreq + (rpm / 15);
                    osc.current.o.frequency.setTargetAtTime(freq, audioCtx.current.currentTime, 0.1);
                    
                    // Volume/Distortion
                    const vol = ignition ? 0.1 + (rpm / 20000) : 0;
                    osc.current.g.gain.setTargetAtTime(vol, audioCtx.current.currentTime, 0.1);
                }
            }, [rpm, ignition, selectedCar]);

            // Dyno Run Logic
            const runDyno = () => {
                if (!ignition) {
                    alert("Start Engine First!");
                    return;
                }
                setDynoRunning(true);
                setData([]);
                
                let currentRpm = 2000;
                const maxRpm = selectedCar.type === 'v10' || selectedCar.type === 'v12' ? 9000 : 7200;
                
                const interval = setInterval(() => {
                    currentRpm += 80; // Sweep speed

                    // Math for Power Curve
                    // HP = TQ * RPM / 5252
                    // Peak TQ usually early/mid range
                    let peakTq = selectedCar.tq * (mods.tune ? 1.2 : 1) * (mods.turbo ? 1.25 : 1);
                    let tqCurve = peakTq * (1 - Math.pow((currentRpm - 4500) / 6000, 2)); // Parabolic curve
                    if (tqCurve < 0) tqCurve = 0;
                    
                    let hp = (tqCurve * currentRpm) / 5252;
                    
                    // Add noise
                    tqCurve += (Math.random() - 0.5) * 5;

                    setData(prev => [...prev, { 
                        rpm: currentRpm, 
                        hp: Math.floor(hp), 
                        tq: Math.floor(tqCurve) 
                    }]);
                    setRpm(currentRpm);

                    if (currentRpm >= maxRpm) {
                        clearInterval(interval);
                        setDynoRunning(false);
                        setRpm(850); // Return to idle
                    }
                }, 30);
            };

            const toggleMod = (mod) => setMods({ ...mods, [mod]: !mods[mod] });

            return (
                <div className="flex h-screen w-full bg-neutral-950 text-white overflow-hidden tech-grid">
                    
                    {/* LEFT PANEL: ENGINE SPECS */}
                    <div className="w-80 flex flex-col border-r border-neutral-800 bg-black/80 backdrop-blur z-20">
                        <div className="p-6 border-b border-neutral-800">
                            <h1 className="text-xl font-bold tracking-tighter text-red-500 flex items-center gap-2">
                                <Cpu size={24} /> ENGINE<span className="text-white">LAB</span>
                            </h1>
                            <div className="text-[10px] text-neutral-500 font-mono mt-1">PHYSICS SIMULATION V1.0</div>
                        </div>

                        <div className="p-4 flex-1 overflow-y-auto">
                            <h2 className="text-xs font-bold text-neutral-500 uppercase mb-3">Power Unit Selection</h2>
                            <div className="space-y-2">
                                {CAR_DB.map(car => (
                                    <button 
                                        key={car.id}
                                        onClick={() => { setSelectedCar(car); setData([]); }}
                                        className={`w-full text-left p-3 rounded border transition-all ${
                                            selectedCar.id === car.id 
                                            ? 'border-red-500 bg-red-900/20 text-white' 
                                            : 'border-neutral-800 bg-neutral-900/40 text-neutral-400 hover:border-neutral-600'
                                        }`}
                                    >
                                        <div className="font-bold text-sm">{car.name}</div>
                                        <div className="text-[10px] opacity-70 font-mono mt-1">{car.desc}</div>
                                    </button>
                                ))}
                            </div>

                            <h2 className="text-xs font-bold text-neutral-500 uppercase mt-8 mb-3">Upgrades</h2>
                            <div className="space-y-2">
                                {['tune', 'turbo', 'exhaust'].map(mod => (
                                    <button 
                                        key={mod}
                                        onClick={() => toggleMod(mod)}
                                        className={`w-full flex justify-between items-center p-2 rounded border text-xs font-mono uppercase ${
                                            mods[mod] ? 'border-green-500 text-green-400' : 'border-neutral-800 text-neutral-500'
                                        }`}
                                    >
                                        <span>{mod.toUpperCase()}</span>
                                        <div className={`w-2 h-2 rounded-full ${mods[mod] ? 'bg-green-500' : 'bg-neutral-800'}`}></div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* CENTER: 3D ENGINE */}
                    <div className="flex-1 flex flex-col relative">
                        <div className="absolute top-4 left-4 z-10 pointer-events-none">
                            <div className="text-4xl font-black text-white/10 uppercase tracking-tighter">{selectedCar.type} ARCHITECTURE</div>
                        </div>

                        <Canvas shadows dpr={[1, 2]}>
                            <Scene engineType={selectedCar.type} rpm={rpm} isRunning={ignition} />
                        </Canvas>
                        
                        {/* RPM GAUGE OVERLAY */}
                        <div className="absolute top-4 right-4 bg-black/50 backdrop-blur border border-neutral-800 p-4 rounded text-right">
                             <div className="text-4xl font-mono font-bold text-white flex items-baseline justify-end gap-2">
                                {Math.round(rpm)} <span className="text-sm text-neutral-500">RPM</span>
                             </div>
                             <div className="h-2 w-48 bg-neutral-800 mt-2 rounded overflow-hidden">
                                <div 
                                    className={`h-full transition-all duration-75 ${rpm > 7000 ? 'bg-red-500' : 'bg-white'}`} 
                                    style={{ width: `${(rpm/9000)*100}%` }}
                                ></div>
                             </div>
                        </div>
                    </div>

                    {/* BOTTOM: CONTROLS & DYNO */}
                    <div className="h-64 border-t border-neutral-800 bg-black/90 flex flex-col md:flex-row">
                        <div className="w-64 p-6 border-r border-neutral-800 flex flex-col gap-4 justify-center items-center">
                            <button 
                                onClick={() => setIgnition(!ignition)}
                                className={`w-full py-4 rounded font-bold text-lg tracking-widest border transition-all ${
                                    ignition 
                                    ? 'bg-red-500 text-black border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]' 
                                    : 'bg-transparent text-neutral-500 border-neutral-700 hover:text-white hover:border-white'
                                }`}
                            >
                                {ignition ? 'STOP ENGINE' : 'START ENGINE'}
                            </button>

                            <button 
                                onClick={runDyno}
                                disabled={!ignition || dynoRunning}
                                className={`w-full py-2 rounded text-sm font-mono border transition-all ${
                                    dynoRunning 
                                    ? 'bg-neutral-800 text-neutral-600 border-neutral-800' 
                                    : 'bg-neutral-900 text-cyan-400 border-cyan-900 hover:border-cyan-400'
                                }`}
                            >
                                {dynoRunning ? 'DYNO RUNNING...' : 'START DYNO PULL'}
                            </button>
                        </div>

                        <div className="flex-1 p-4">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={data}>
                                    <defs>
                                        <linearGradient id="hpGrad" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#06b6d4" stopOpacity={0.3}/>
                                            <stop offset="95%" stopColor="#06b6d4" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#222" />
                                    <XAxis dataKey="rpm" stroke="#444" tick={{fontSize: 10}} />
                                    <YAxis stroke="#444" tick={{fontSize: 10}} />
                                    <RechartsTooltip contentStyle={{ backgroundColor: '#111', border: '1px solid #333' }} />
                                    <Area type="monotone" dataKey="hp" stroke="#06b6d4" fill="url(#hpGrad)" strokeWidth={2} name="HP" isAnimationActive={false} />
                                    <Line type="monotone" dataKey="tq" stroke="#f43f5e" strokeWidth={2} dot={false} strokeDasharray="5 5" name="Torque" isAnimationActive={false} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
